<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuthenticationController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">PMDB</a> &gt; <a href="index.source.html" class="el_package">org.xandercat.pmdb.controller</a> &gt; <span class="el_source">AuthenticationController.java</span></div><h1>AuthenticationController.java</h1><pre class="source lang-java linenums">package org.xandercat.pmdb.controller;

import javax.servlet.http.HttpSession;
import javax.validation.Valid;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.xandercat.pmdb.dto.PmdbUser;
import org.xandercat.pmdb.exception.ServiceLimitExceededException;
import org.xandercat.pmdb.form.useradmin.UserForm;
import org.xandercat.pmdb.service.CollectionService;
import org.xandercat.pmdb.service.UserService;
import org.xandercat.pmdb.util.Alerts;
import org.xandercat.pmdb.util.ViewUtil;
import org.xandercat.pmdb.util.format.FormatUtil;

/**
 * Controller for basic authentication and registration functions.
 * 
 * @author Scott Arnold
 */
@Controller
<span class="nc" id="L33">public class AuthenticationController {</span>

<span class="nc" id="L35">	private static final Logger LOGGER = LogManager.getLogger(AuthenticationController.class);</span>
	
	@Value(&quot;${pmdb.environment}&quot;)
	private String environment;

	@Autowired
	private UserService userService;
	
	@Autowired
	private CollectionService collectionService;
	
	/**
	 * Page for presenting user login.
	 * 
	 * @param model  model
	 * 
	 * @return page for presenting user login
	 */
	@RequestMapping(value=&quot;/login.html&quot;, method=RequestMethod.GET)
	public String login(Model model) {
<span class="nc" id="L55">		model.addAttribute(&quot;environment&quot;, environment);</span>
<span class="nc" id="L56">		return &quot;authentication/login&quot;;</span>
	}
	
	/**
	 * Page for presenting user login error.
	 * 
	 * @param model  model
	 * 
	 * @return page for presenting user login error
	 */
	@RequestMapping(&quot;/login-error.html&quot;)
	public String loginError(Model model) {
<span class="nc" id="L68">		model.addAttribute(&quot;loginError&quot;, &quot;Unable to login.&quot;);</span>
<span class="nc" id="L69">		model.addAttribute(&quot;environment&quot;, environment);</span>
<span class="nc" id="L70">		return &quot;authentication/login&quot;;</span>
	}
	
	/**
	 * Process user login and redirect to user home page. Prepares session for user and updates user login information.
	 * 
	 * @param session  session
	 * 
	 * @return redirect to user home page
	 */
	@RequestMapping(value=&quot;/afterLogin.html&quot;, method=RequestMethod.GET)
	public String loginProcess(HttpSession session) {
<span class="nc" id="L82">		UsernamePasswordAuthenticationToken authentication = (UsernamePasswordAuthenticationToken) SecurityContextHolder.getContext().getAuthentication();</span>
<span class="nc" id="L83">		PmdbUser user = (PmdbUser) authentication.getPrincipal();</span>
<span class="nc" id="L84">		LOGGER.info(&quot;User logged in: &quot; + user.getUsername());</span>
<span class="nc" id="L85">		userService.updateLastAccess(user.getUsername());</span>
		try {
<span class="nc" id="L87">			ViewUtil.updateNumShareOffers(collectionService, session, user.getUsername());</span>
<span class="nc" id="L88">		} catch (Exception e) {</span>
<span class="nc" id="L89">			LOGGER.error(&quot;Unable to retrieve number of share offers for user.&quot;, e);</span>
<span class="nc" id="L90">		}</span>
<span class="nc" id="L91">		return &quot;redirect:/&quot;;</span>
	}
	
	/**
	 * Page for presenting new user registration.
	 * 
	 * @param model  model
	 * 
	 * @return page for presenting new user registration
	 */
	@RequestMapping(value=&quot;/loginRegister&quot;, method=RequestMethod.GET)
	public String register(Model model) {
<span class="nc" id="L103">		model.addAttribute(&quot;userForm&quot;, new UserForm());</span>
<span class="nc" id="L104">		return &quot;authentication/register&quot;;</span>
	}
	
	/**
	 * Process new user registration and present registration result.
	 * 
	 * @param model     model
	 * @param userForm  user information form
	 * @param result    binding result
	 * 
	 * @return registration result page
	 */
	@RequestMapping(value=&quot;/loginRegisterSubmit&quot;, method=RequestMethod.POST)
	public String registerSubmit(Model model,
			@ModelAttribute(&quot;userForm&quot;) @Valid UserForm userForm,
			BindingResult result) {
		// password annotation ignores blank passwords, so need to check for that here
<span class="nc bnc" id="L121" title="All 2 branches missed.">		if (FormatUtil.isBlank(userForm.getPasswordPair().getFirst())) {</span>
<span class="nc" id="L122">			result.rejectValue(&quot;passwordPair&quot;, &quot;{userform.password.required}&quot;, &quot;Password cannot be blank.&quot;);</span>
		}
<span class="nc bnc" id="L124" title="All 4 branches missed.">		if (FormatUtil.isValidUsername(userForm.getUsername()) &amp;&amp; userService.getUser(userForm.getUsername()).isPresent()) {</span>
<span class="nc" id="L125">			result.rejectValue(&quot;username&quot;, &quot;{userform.username.alreadyexists}&quot;, &quot;A user with that username already exists.&quot;);</span>
		}
<span class="nc bnc" id="L127" title="All 2 branches missed.">		if (result.hasErrors()) {</span>
<span class="nc" id="L128">			return &quot;authentication/register&quot;;</span>
		}
<span class="nc" id="L130">		PmdbUser user = userForm.toUser();</span>
		try {
<span class="nc" id="L132">			userService.registerUser(user, userForm.getPasswordPair().getFirst().trim());</span>
<span class="nc" id="L133">			model.addAttribute(&quot;registrationSuccess&quot;, Boolean.TRUE);</span>
<span class="nc" id="L134">		} catch (ServiceLimitExceededException slee) {</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">			if (slee.isInitialTrigger()) {</span>
<span class="nc" id="L136">				LOGGER.error(&quot;Excessive registrations.&quot;, slee);</span>
			}
<span class="nc" id="L138">			Alerts.setErrorMessage(model, &quot;Too many user accounts have been created in a short amount of time.  Please try again later.&quot;);</span>
<span class="nc" id="L139">		} catch (Exception e) {</span>
<span class="nc" id="L140">			LOGGER.error(&quot;Unable to register user.&quot;, e);</span>
<span class="nc" id="L141">			Alerts.setErrorMessage(model, &quot;The system was unable to register your account.&quot;);			</span>
<span class="nc" id="L142">		}</span>
<span class="nc" id="L143">		return &quot;authentication/registerResult&quot;;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>